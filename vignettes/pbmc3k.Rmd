---
title: "pbmc3k"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{pbmc3k}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Here we explore the use of `sneezy` on the 10x genomics PBMC3k single-cell
dataset. We follow the preprocessing and quality control steps from
[Chapter 25 of Orchestrating Single Cell Analysis with R](https://osca.bioconductor.org/pbmc-3k-10x-dataset-filtered.html), and
use that to explore the linear and non-linear embedding spaces via tours
and diagnostics.

## Setup

First, we load up the raw data from the `TENxPBMCData` package,
and the analysis packages `scater` and `scran`:

```{r setup}
library(TENxPBMCData)
library(scater)
library(scran)

pbmc3k <- TENxPBMCData("pbmc3k")
pbmc3k
```

Next we follow the simple QC steps from the aforementioned vignette:

### Quality control

```{r qc}
is.mito <- grep("MT", rowData(pbmc3k)$Symbol_TENx)
stats <- perCellQCMetrics(pbmc3k, subsets=list(Mito=is.mito))
high.mito <- isOutlier(stats$subsets_Mito_percent, nmads=3, type="higher")
pbmc3k <- pbmc3k[,!high.mito]
```

### Normalization

```{r}
pbmc3k <- logNormCounts(pbmc3k)
```

### Variance modelling

```{r}
dec3k <- modelGeneVar(pbmc3k)
chosen.hvgs <- which(dec3k$bio > 0)
```


## Construction of a TourExperiment

Now that we have the `TourExperiment` in place, we can construct a linear-
embedding using PCA. Since, the underlying object is backed by an HDF5 object
we use randomized PCA as our backend.

```{r}
#library(sneezy)
set.seed(1999)
pbmc3k_te <- TourExperiment(pbmc3k)
pbmc3k_te <- embed_linear(pbmc3k_te, 
                          num_comp = 25, 
                          .on = "logcounts", 
                          .subset = chosen.hvgs, 
                          .engine = pca_random())
```